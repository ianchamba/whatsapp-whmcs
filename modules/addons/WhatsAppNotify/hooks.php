<?php

if (!defined("WHMCS")) die("Acesso restrito.");

use WHMCS\Database\Capsule;

/**
 * Processa o n√∫mero de telefone para garantir que ele siga o formato correto.
 *
 * @param string $phonenumber O n√∫mero de telefone no formato original.
 * @return string O n√∫mero de telefone processado.
 */
function processarNumeroTelefone($phonenumber) {
    // Remove caracteres '+' e '.'
    return str_replace(['+', '.'], '', $phonenumber);
}

function getTemplate($event)
{
    // Templates padr√£o
    $defaultTemplates = [
        'InvoiceCreation' => "*Fatura em Aberto* \n\n".
            "Ol√° {primeiro_nome}, tudo bem? ‚ò∫Ô∏è\n\n".
            "üîñ Voc√™ possui uma fatura em aberto #{id_fatura}.\n".
            "üíµ Valor: R$ {valor}\n".
            "üí≥ M√©todo de Pagamento: {metodo_pagamento}\n".
            "üì¶ Produtos: {produtos_lista}\n\n".
            "Para acessar sua fatura, clique no link abaixo:\n\n".
            "{link_fatura}\n\n".
            "_Equipe Hostbraza_",
        'InvoicePaid' => "*Fatura Paga* \n\n".
            "Ol√° {primeiro_nome}, tudo bem? ‚ò∫Ô∏è\n\n".
            "‚úÖ Sua fatura #{id_fatura} foi paga com sucesso.\n".
            "üíµ Valor: R$ {valor}\n".
            "üí≥ M√©todo de Pagamento: {metodo_pagamento}\n".
            "üì¶ Produtos: {produtos_lista}\n\n".
            "Obrigado por escolher nossos servi√ßos! Estamos sempre √† disposi√ß√£o. üíô" . "\n\n" .
            "_Equipe Hostbraza_",
        'InvoiceCancelled' => "*Fatura Cancelada* \n\n".
            "Ol√° {primeiro_nome}, tudo bem? ‚ò∫Ô∏è\n\n".
            "‚ö†Ô∏è Informamos que a fatura #{id_fatura} foi cancelada.\n".
            "üíµ Valor: R$ {valor}\n".
            "üí≥ M√©todo de Pagamento: {metodo_pagamento}\n".
            "üì¶ Produtos: {produtos_lista}\n\n".
            "Se precisar de mais informa√ß√µes ou ajuda, estamos √† disposi√ß√£o. üíô" . "\n\n" .
            "_Equipe Hostbraza_",
        'InvoicePaymentReminder' => "*Lembrete de Pagamento* \n\n".
            "Ol√° {primeiro_nome}, tudo bem? ‚ò∫Ô∏è\n\n".
            "Esta mensagem √© apenas um lembrete referente a fatura #{id_fatura} gerada em {data_geracao} com vencimento {data_vencimento}.\n".
            "üíµ Valor: R$ {valor}\n".
            "üí≥ M√©todo de Pagamento: {metodo_pagamento}\n".
            "üì¶ Produtos: {produtos_lista}\n\n".
            "Para acessar sua fatura, clique no link abaixo:\n\n".
            "{link_fatura}\n\n" .
            "_Equipe Hostbraza_",
        'LateInvoicePaymentReminder' => "*Fatura em Atraso* \n\n" .
            "Ol√° {primeiro_nome}, tudo bem? ‚ò∫Ô∏è\n\n" .
            "Gostar√≠amos de lembr√°-lo de que a fatura #{id_fatura}, gerada em {data_geracao}, com vencimento em {data_vencimento}, ainda est√° pendente. Para evitar qualquer interrup√ß√£o nos seus servi√ßos, pedimos que regularize o pagamento o quanto antes.\n" .
            "üíµ Valor: R$ {valor}\n" .
            "üí≥ M√©todo de Pagamento: {metodo_pagamento}\n" .
            "üì¶ Produtos: {produtos_lista}\n\n" .
            "Para acessar sua fatura, clique no link abaixo:\n\n" .
            "{link_fatura}\n\n" .
            "_Equipe Hostbraza_",
    ];

    // Busca o template na tabela `tbladdonwhatsapp`
    $template = Capsule::table('tbladdonwhatsapp')
        ->where('event', $event)
        ->value('template');

    // Retorna o template encontrado ou o padr√£o
    return $template ?? $defaultTemplates[$event] ?? "Template n√£o configurado.";
}

/**
 * Envia uma mensagem no WhatsApp usando a API especificada com dados da fatura e do cliente.
 *
 * @param string $event O nome do evento (InvoiceCreation, InvoicePaid, InvoiceCancelled).
 * @param array $invoiceData Dados da fatura a serem enviados na mensagem.
 * @param array $clientData Dados do cliente a serem enviados na mensagem.
 */
// Fun√ß√£o de envio de mensagem no WhatsApp com link de autologin
function enviarMensagemWhatsApp($event, $invoiceData, $clientData) {
    
    // Recupera as configura√ß√µes do m√≥dulo
    $settings = Capsule::table('tbladdonmodules')
        ->where('module', 'WhatsAppNotify')
        ->pluck('value', 'setting');

    // Configura√ß√µes din√¢micas
    $apiKey = $settings['apiKey'] ?? 'default_api_key';
    $apiDomain = $settings['apiDomain'] ?? 'api.example.com';
    $whatsAppInstance = $settings['whatsAppInstance'] ?? 'DefaultInstance';

    // URL da API
    $url = "https://$apiDomain/message/sendText/$whatsAppInstance";
    
    // Processa o n√∫mero de telefone
    $number = processarNumeroTelefone($clientData['phonenumberformatted']);
        
    $produtos = array_map(function($item) {
        return trim(preg_replace('/\s*\(\d{2}\/\d{2}\/\d{4} - \d{2}\/\d{2}\/\d{4}\)(.|\s)*/', '', $item['description']));
    }, $invoiceData['items']['item']);
    
    $template = getTemplate($event);

    $placeholders = [
        '{primeiro_nome}' => trim($clientData['firstname']),
        '{id_fatura}' => $invoiceData['invoiceid'],
        '{metodo_pagamento}' => $metodoPagamento = $invoiceData['paymentmethod'] === 'openpix' 
        ? 'Pix' 
        : ($invoiceData['paymentmethod'] === 'mercadopago_1' 
            ? 'MercadoPago' 
            : ($invoiceData['paymentmethod'] === 'stripe' 
                ? 'Cart√£o de Cr√©dito/D√©bito' 
                : $invoiceData['paymentmethod'])),
        '{valor}' => number_format($invoiceData['total'], 2, ',', '.'),
        '{data_geracao}' => DateTime::createFromFormat('Y-m-d', $invoiceData['date'])->format('d/m/Y'),
        '{data_vencimento}' => DateTime::createFromFormat('Y-m-d', $invoiceData['duedate'])->format('d/m/Y'),
        '{produtos_lista}' => implode(", ", $produtos),
        '{link_fatura}' => function_exists('gerarLinkAutoLogin') 
        ? gerarLinkAutoLogin($clientData['id'], 'clientarea', "viewinvoice.php?id={$invoiceData['invoiceid']}") 
        : 'AutoLogin Desativado',
    ];

    // Substituir vari√°veis no template
    $text = str_replace(array_keys($placeholders), array_values($placeholders), $template);

    $headers = [
        'Content-Type: application/json',
        'apikey: ' . $apiKey
    ];
    $body = [
        "number" => $number,
        "text" => $text,
        "linkPreview" => false
    ];

    // Log de debug - dados da mensagem
    error_log("Preparando envio de mensagem para o evento '$event' com n√∫mero '$number' e dados: " . json_encode($body));

    // Inicializa o cURL
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($body));
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

    // Execu√ß√£o da solicita√ß√£o
    $response = curl_exec($ch);
    $httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $error = curl_error($ch);

    // Verifica√ß√£o e log de erro
    if ($response === false) {
        error_log("Erro no envio da mensagem para o evento '$event'. Erro: $error");
    } else {
        error_log("Mensagem enviada com sucesso para o evento '$event'. C√≥digo HTTP: $httpcode, Resposta: $response");
    }

    // Fecha o cURL
    curl_close($ch);
}

function enviarMensagemPix($event, $invoiceData, $clientData) {
    
    // Recupera as configura√ß√µes do m√≥dulo
    $settings = Capsule::table('tbladdonmodules')
        ->where('module', 'WhatsAppNotify')
        ->pluck('value', 'setting');

    // Configura√ß√µes din√¢micas
    $apiKey = $settings['apiKey'] ?? 'default_api_key';
    $apiDomain = $settings['apiDomain'] ?? 'api.example.com';
    $whatsAppInstance = $settings['whatsAppInstance'] ?? 'DefaultInstance';

    // URL da API
    $url = "https://$apiDomain/message/sendText/$whatsAppInstance";
    
    // Processa o n√∫mero de telefone
    $number = processarNumeroTelefone($clientData['phonenumberformatted']);

    // Define o conte√∫do da mensagem conforme o status da fatura
    if ($invoiceData['paymentmethod'] === 'openpix' && $invoiceData['status'] === 'Unpaid') {
        
        // Tentativas para obter o brCode
        $tentativas = 0;
        $maxTentativas = 5;
        $brCode = null;

        while ($tentativas < $maxTentativas && !$brCode) {
            // Busca o registro da fatura e acessa a coluna 'brCode'
            $invoice = Capsule::table('tblinvoices')
                ->where('id', $invoiceData['invoiceid'])
                ->first();
                error_log("Metadata Pix: " . print_r($invoice, true));
            
            if ($invoice && isset($invoice->brCode)) {
                $brCode = $invoice->brCode;
                error_log("brCode encontrado: $brCode");
            } else {
                $brCode = null;
                error_log("brCode n√£o encontrado na tentativa " . ($tentativas + 1) . ". Retentando em 1 segundo...");
                sleep(1);
            }

            $tentativas++;
        }

        if (!$brCode) {
            $textPart1 = "*C√≥digo Pix N√£o Encontrado*";
            error_log("Falha ao encontrar brCode ap√≥s $maxTentativas tentativas.");
        } else {
            $textPart1 = "*Copie o c√≥digo Pix abaixo para efetuar o pagamento:* üëá";
            $textPart2 = $brCode;
        }

        $headers = [
            'Content-Type: application/json',
            'apikey: ' . $apiKey
        ];

        // Fun√ß√£o para enviar mensagens
        $sendMessage = function($text, $additionalFields = []) use ($url, $headers, $number, $event) {
            $body = array_merge([
                "number" => $number,
                "text" => $text,
                "linkPreview" => false
            ], $additionalFields);

            // Log de debug - dados da mensagem
            error_log("Preparando envio de mensagem para o evento '$event' com n√∫mero '$number' e dados: " . json_encode($body));

            // Inicializa o cURL
            $ch = curl_init();
            curl_setopt($ch, CURLOPT_URL, $url);
            curl_setopt($ch, CURLOPT_POST, true);
            curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($body));
            curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

            // Execu√ß√£o da solicita√ß√£o
            $response = curl_exec($ch);
            $httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
            $error = curl_error($ch);

            // Verifica√ß√£o e log de erro
            if ($response === false) {
                error_log("Erro no envio da mensagem para o evento '$event'. Erro: $error");
            } else {
                error_log("Mensagem enviada com sucesso para o evento '$event'. C√≥digo HTTP: $httpcode, Resposta: $response");
            }

            // Fecha o cURL
            curl_close($ch);
        };

        // Enviar a primeira parte da mensagem
        $sendMessage($textPart1);

        // Enviar a segunda parte da mensagem (se aplic√°vel)
        if (isset($textPart2)) {
            $sendMessage($textPart2, ["delay" => 3000]);
        }
    }
}

function enviarMensagemWhatsAppAffiliate($number, $text) {
    
    // Recupera as configura√ß√µes do m√≥dulo
    $settings = Capsule::table('tbladdonmodules')
        ->where('module', 'WhatsAppNotify')
        ->pluck('value', 'setting');

    // Configura√ß√µes din√¢micas
    $apiKey = $settings['apiKey'] ?? 'default_api_key';
    $apiDomain = $settings['apiDomain'] ?? 'api.example.com';
    $whatsAppInstance = $settings['whatsAppInstance'] ?? 'DefaultInstance';

    // URL da API
    $url = "https://$apiDomain/message/sendText/$whatsAppInstance";
    
    $headers = [
        'Content-Type: application/json',
        'apikey: ' . $apiKey
    ];
    $body = [
        "number" => $number,
        "text" => $text,
        "linkPreview" => false
    ];

    // Log de debug - dados da mensagem
    error_log("Preparando envio de mensagem para n√∫mero '$number' com dados: " . json_encode($body));

    // Inicializa o cURL
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($body));
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

    // Execu√ß√£o da solicita√ß√£o
    $response = curl_exec($ch);
    $httpcode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $error = curl_error($ch);

    // Verifica√ß√£o e log de erro
    if ($response === false) {
        error_log("Erro no envio da mensagem. Erro: $error");
    } else {
        error_log("Mensagem enviada com sucesso. C√≥digo HTTP: $httpcode, Resposta: $response");
    }

    // Fecha o cURL
    curl_close($ch);
}

// Hook para InvoiceCreation
add_hook('InvoiceCreation', 1, function($vars) {
    $invoiceData = localAPI('GetInvoice', ['invoiceid' => $vars['invoiceid']]);
    $clientData = localAPI('GetClientsDetails', ['clientid' => $invoiceData['userid'], 'stats' => true]);
    error_log("Hook 'InvoiceCreation' ativado. Dados da Fatura: " . print_r($invoiceData, true) . " Dados do Cliente: " . print_r($clientData, true));
    enviarMensagemWhatsApp('InvoiceCreation', $invoiceData, $clientData);
});

add_hook('OpenpixInvoiceGenerated', 1, function($vars) {
    $invoiceId = $vars['invoiceId'];

    // Verifica se o invoice j√° foi processado
    $invoice = Capsule::table('tblinvoices')->where('id', $invoiceId)->first();
    if ($invoice && $invoice->processed) {
        error_log("Invoice ID $invoiceId j√° foi processado. Ignorando.");
        return;
    }

    // Obtenha os dados da fatura e do cliente e envie a mensagem
    $invoiceData = localAPI('GetInvoice', ['invoiceid' => $invoiceId]);
    $clientData = localAPI('GetClientsDetails', ['clientid' => $invoiceData['userid'], 'stats' => true]);
    error_log("Hook 'OpenpixInvoiceGenerated' triggered. Invoice Data: " . print_r($invoiceData, true) . " Client Data: " . print_r($clientData, true));
    enviarMensagemPix('OpenpixInvoiceGenerated', $invoiceData, $clientData);

    // Atualiza o status de processamento no banco de dados
    Capsule::table('tblinvoices')->where('id', $invoiceId)->update(['processed' => 1]);
});

// Hook para InvoicePaid
add_hook('InvoicePaid', 1, function($vars) {
    $invoiceData = localAPI('GetInvoice', ['invoiceid' => $vars['invoiceid']]);
    $clientData = localAPI('GetClientsDetails', ['clientid' => $invoiceData['userid'], 'stats' => true]);
    error_log("Hook 'InvoicePaid' ativado. Dados da Fatura: " . print_r($invoiceData, true) . " Dados do Cliente: " . print_r($clientData, true));
    enviarMensagemWhatsApp('InvoicePaid', $invoiceData, $clientData);
});

// Hook para InvoiceCancelled
add_hook('InvoiceCancelled', 1, function($vars) {
    $invoiceData = localAPI('GetInvoice', ['invoiceid' => $vars['invoiceid']]);
    $clientData = localAPI('GetClientsDetails', ['clientid' => $invoiceData['userid'], 'stats' => true]);
    error_log("Hook 'InvoiceCancelled' ativado. Dados da Fatura: " . print_r($invoiceData, true) . " Dados do Cliente: " . print_r($clientData, true));
    enviarMensagemWhatsApp('InvoiceCancelled', $invoiceData, $clientData);
});

// Hook para InvoicePaymentReminder
add_hook('InvoicePaymentReminder', 1, function($vars) {
    $invoiceData = localAPI('GetInvoice', ['invoiceid' => $vars['invoiceid']]);
    $clientData = localAPI('GetClientsDetails', ['clientid' => $invoiceData['userid'], 'stats' => true]);
    error_log("Hook 'InvoicePaymentReminder' ativado. Dados da Fatura: " . print_r($invoiceData, true) . " Dados do Cliente: " . print_r($clientData, true));
    $dueDate = $invoiceData['duedate'];
    $currentDate = date('Y-m-d');
    if ($currentDate > $dueDate) {
        enviarMensagemWhatsApp('LateInvoicePaymentReminder', $invoiceData, $clientData);
    } else {
        enviarMensagemWhatsApp('InvoicePaymentReminder', $invoiceData, $clientData);
    }
});

/**
 * Hook para AffiliateWithdrawalRequest para enviar notifica√ß√£o de solicita√ß√£o de retirada.
 */
add_hook('AffiliateWithdrawalRequest', 1, function($vars) {
    // Log detalhado do conte√∫do da vari√°vel $vars para depura√ß√£o
    error_log("Hook 'AffiliateWithdrawalRequest' ativado. Dados do Hook: " . print_r($vars, true));

    $affiliateId = $vars['affiliateId'] ?? 'Desconhecido';
    $userId = $vars['userId'] ?? 'Desconhecido';
    $clientId = $vars['clientId'] ?? 'Desconhecido';
    $balanceFormatado = $vars['balance'] ?? 'Desconhecido';
    $balance = number_format($balanceFormatado, 2, ',', '.');

    // Obter informa√ß√µes do afiliado
    $user = Capsule::table('tblclients')->where('id', $userId)->first();
    $firstName = $user->firstname ?? 'Nome Desconhecido';
    $email = $user->email ?? 'E-mail Desconhecido';
    $phoneNumber = $user->phonenumber ?? null;
    $phoneNumberFormatted = processarNumeroTelefone($phoneNumber);

    // Mensagem para o administrador
    $adminText = "*Notifica√ß√£o de Solicita√ß√£o de Retirada de Afiliado* \n\n" .
                 "üîî Um afiliado solicitou retirada de comiss√£o.\n" .
                 "üÜî ID do Afiliado: $affiliateId\n" .
                 "üë§ Nome: $firstName\n" .
                 "üìß E-mail: $email\n" .
                 "üë• ID do Cliente: $clientId\n" .
                 "üí∞ Saldo da Conta: R$ $balance\n\n" .
                 "_Equipe Hostbraza_";

    // Envia a mensagem para o administrador
    enviarMensagemWhatsAppAffiliate('5561995940410', $adminText);

    // Mensagem para o afiliado, caso o n√∫mero de telefone esteja dispon√≠vel
    if ($phoneNumberFormatted) {
        $affiliateText = "*Solicita√ß√£o de Retirada Recebida* \n\n" .
                         "Ol√° $firstName,\n\n" .
                         "üîî Recebemos sua solicita√ß√£o de retirada de comiss√£o no valor de R$ $balance. " .
                         "Nossa equipe est√° analisando e em breve voc√™ ser√° notificado sobre o andamento.\n\n" .
                         "_Equipe Hostbraza_";

        enviarMensagemWhatsAppAffiliate($phoneNumberFormatted, $affiliateText);
    } else {
        error_log("N√∫mero de telefone n√£o encontrado para o afiliado com ID '$affiliateId'.");
    }
});
